#!/usr/bin/env node

var fs = require('fs');
var os = require('os');
var dl = require('./download_files');
var AdmZip = require('adm-zip')


// Download the Selenium Standalone jar and the ChromeDriver binary to
// ./selenium/
// Thanks to http://www.hacksparrow.com/using-node-js-to-download-files.html
// for the outline of this code.
var SELENIUM_URL =
    'https://selenium.googlecode.com/files/selenium-server-standalone-2.37.0.jar';
var CHROMEDRIVER_URL_MAC =
    'https://chromedriver.storage.googleapis.com/2.6/chromedriver_mac32.zip';
var CHROMEDRIVER_URL_LINUX32 =
    'https://chromedriver.storage.googleapis.com/2.6/chromedriver_linux32.zip';
var CHROMEDRIVER_URL_LINUX64 =
    'https://chromedriver.storage.googleapis.com/2.6/chromedriver_linux64.zip';
var CHROMEDRIVER_URL_WINDOWS =
    'https://chromedriver.storage.googleapis.com/2.6/chromedriver_win32.zip';


var DOWNLOAD_DIR = './selenium/';
var START_SCRIPT_FILENAME = DOWNLOAD_DIR + 'start';
var chromedriver_url = '';
var start_script = 'java -jar selenium/selenium-server-standalone-2.37.0.jar';



if (!fs.existsSync(DOWNLOAD_DIR) || !fs.statSync(DOWNLOAD_DIR).isDirectory()) {
  fs.mkdirSync(DOWNLOAD_DIR);
}

console.log(
  'When finished, start the Selenium Standalone Server with ./selenium/start \n');

dl.download_file_httpget(SELENIUM_URL,DOWNLOAD_DIR);

if (!(process.argv[2] == '--nocd')) {
  if (os.type() == 'Darwin') {
    chromedriver_url = CHROMEDRIVER_URL_MAC;
  } else if (os.type() == 'Linux') {
    if (os.arch() == 'x64') {
      chromedriver_url = CHROMEDRIVER_URL_LINUX64;
    } else {
      chromedriver_url = CHROMEDRIVER_URL_LINUX32;
    }
  } else if (os.type() == 'Windows_NT') {
    chromedriver_url = CHROMEDRIVER_URL_WINDOWS;
  }

  
  var chromedriver_zip = chromedriver_url.split('/').pop();
  start_script += ' -Dwebdriver.chrome.driver=./selenium/chromedriver';

  dl.download_file_httpget(chromedriver_url,DOWNLOAD_DIR, function(file_name) {
    var zip = new AdmZip(file_name);
    zip.extractAllTo(DOWNLOAD_DIR);
    if (os.type() != 'Windows_NT') {
      fs.chmod(DOWNLOAD_DIR + 'chromedriver', 0755);
    }
  });

}

var start_script_file = fs.createWriteStream(START_SCRIPT_FILENAME);
start_script_file.write(start_script);
start_script_file.end(function() {
  fs.chmod(START_SCRIPT_FILENAME, 0755);
});

